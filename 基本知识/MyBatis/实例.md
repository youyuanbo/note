# Mybatis实例

## 数据库脚本

```sql
use mybatis;

drop table if exists user;
create table user(
  id              int auto_increment comment '用户id',
  username        varchar(32) not null comment '用户姓名',
  birthday        date comment '用户生日',
  sex             char comment '用户性别，0代表女性，1代表男性',
  address         varchar(256) comment '用户地址',
  primary key (id)
);


drop table if exists orders;
create table orders(
  id          int auto_increment,
  user_id     int not null comment '下单用户id',
  number      varchar(32) not null comment '订单号',
  create_time date not null comment '创建订单时间',
  note        varchar(100) comment '备注',
  primary key (id) comment '主键',
  foreign key (user_id) references user(id)
);


drop table if exists items;
create table items(
  id              int auto_increment comment '商品id',
  name            varchar(32) not null comment '商品名称',
  price           float not null comment '商品价格',
  detail          text comment '商品描述',
  pic             varchar(512) comment '商品图片',
  create_time     datetime comment '生产日期',
  primary key (id)
);


drop table if exists order_detail;
create table order_detail(
  id              int auto_increment comment '订单明细id',
  orders_id       int comment '订单id',
  items_id        int comment '商品id',
  items_num       int comment '商品数量',
  primary key (id),
  foreign key (orders_id) references orders(id),
  foreign key (items_id) references items(id)
);
```

## jdbc.properties

```properties
driver=com.mysql.jdbc.Driver
url=jdbc:mysql://localhost:3306/mybatis
username=root
password=root
```

## mybatis.cfg.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE configuration PUBLIC "-//mybatis.org//DTD Config 3.0//EN" "http://mybatis.org/dtd/mybatis-3-config.dtd">
<configuration>

    <properties resource="jdbc.properties"></properties>

    <settings>
        <!-- Globally enables or disables any caches configured in any mapper under this configuration -->
        <setting name="cacheEnabled" value="false"/>
        <!-- Sets the number of seconds the driver will wait for a response from the database -->
        <setting name="defaultStatementTimeout" value="5"/>
        <!-- Enables automatic mapping from classic database column names A_COLUMN to camel case classic Java property names aColumn -->
        <setting name="mapUnderscoreToCamelCase" value="true"/>
        <!-- Allows JDBC support for generated keys. A compatible driver is required.
        This setting forces generated keys to be used if set to true,
         as some drivers deny compatibility but still work -->
        <setting name="useGeneratedKeys" value="true"/>

        <!--<setting name="logImpl" value="LOG4J"/>-->
    </settings>

    <!-- Continue editing here -->

    <!--在mybatis.cfg.xml中编写相应的配置-->
    <environments default="dev">
        <environment id="dev">
            <transactionManager type="JDBC"></transactionManager>
            <dataSource type="POOLED">
                <property name="url" value="${url}"/>
                <property name="driver" value="${driver}"/>
                <property name="username" value="${username}"/>
                <property name="password" value="${password}"/>
            </dataSource>
        </environment>
    </environments>


    <mappers>
        <package name="com.mybatis.mapper"/>
    </mappers>



</configuration>
```

## MyBatisUtil工具类

```java
package com.mybatis.util;

import org.apache.ibatis.io.Resources;
import org.apache.ibatis.session.SqlSession;
import org.apache.ibatis.session.SqlSessionFactory;
import org.apache.ibatis.session.SqlSessionFactoryBuilder;

import java.io.IOException;
import java.io.InputStream;


public class MyBatisUtil {

    private static SqlSessionFactory sqlSessionFactory;
    static {
        String resource = "mybatis.cfg.xml";
        InputStream stream = null;
        try {
            stream = Resources.getResourceAsStream(resource);
            sqlSessionFactory = new SqlSessionFactoryBuilder().build(stream);
        } catch (IOException e) {
            e.printStackTrace();
        } finally {
            if (stream != null){
                try {
                    stream.close();
                } catch (IOException e) {
                    e.printStackTrace();
                }
            }
        }
    }

    public static SqlSession getSession(){
        return sqlSessionFactory.openSession();
    }


}
```



## pojo类

1. User类

   ```java
   package com.mybatis.pojo;
   
   import java.util.Date;
   
   public class User {
       private Integer id;
   
       private String username;
   
       private Date birthday;
   
       private String sex;
   
       private String address;
   
       public Integer getId() {
           return id;
       }
   
       public void setId(Integer id) {
           this.id = id;
       }
   
       public String getUsername() {
           return username;
       }
   
       public void setUsername(String username) {
           this.username = username;
       }
   
       public Date getBirthday() {
           return birthday;
       }
   
       public void setBirthday(Date birthday) {
           this.birthday = birthday;
       }
   
       public String getSex() {
           return sex;
       }
   
       public void setSex(String sex) {
           this.sex = sex;
       }
   
       public String getAddress() {
           return address;
       }
   
       public void setAddress(String address) {
           this.address = address;
       }
   
       @Override
       public String toString() {
           return "User{" +
                   "id=" + id +
                   ", username='" + username + '\'' +
                   ", birthday=" + birthday +
                   ", sex='" + sex + '\'' +
                   ", address='" + address + '\'' +
                   '}';
       }
   }
   ```

2. Items类

   ```java
   package com.mybatis.pojo;
   
   import java.util.Date;
   
   public class Items {
       private Integer id;
   
       private String name;
   
       private Double price;
   
       private String detail;
   
       private String pic;
   
       private Date createTime;
   
       public Integer getId() {
           return id;
       }
   
       public void setId(Integer id) {
           this.id = id;
       }
   
       public String getName() {
           return name;
       }
   
       public void setName(String name) {
           this.name = name;
       }
   
       public Double getPrice() {
           return price;
       }
   
       public void setPrice(Double price) {
           this.price = price;
       }
   
       public String getDetail() {
           return detail;
       }
   
       public void setDetail(String detail) {
           this.detail = detail;
       }
   
       public String getPic() {
           return pic;
       }
   
       public void setPic(String pic) {
           this.pic = pic;
       }
   
       public Date getCreateTime() {
           return createTime;
       }
   
       public void setCreateTime(Date createTime) {
           this.createTime = createTime;
       }
   
       @Override
       public String toString() {
           return "Items{" +
                   "id=" + id +
                   ", name='" + name + '\'' +
                   ", price=" + price +
                   ", detail='" + detail + '\'' +
                   ", pic='" + pic + '\'' +
                   ", createTime=" + createTime +
                   '}';
       }
   }
   ```

3. Orders类

   ```java
   package com.mybatis.pojo;
   
   import java.util.Date;
   
   public class Orders {
       private Integer id;
   
       private String number;
   
       private Date createTime;
   
       private String note;
   
       public Integer getId() {
           return id;
       }
   
       public void setId(Integer id) {
           this.id = id;
       }
   
       public String getNumber() {
           return number;
       }
   
       public void setNumber(String number) {
           this.number = number;
       }
   
       public Date getCreateTime() {
           return createTime;
       }
   
       public void setCreateTime(Date createTime) {
           this.createTime = createTime;
       }
   
       public String getNote() {
           return note;
       }
   
       public void setNote(String note) {
           this.note = note;
       }
   
       @Override
       public String toString() {
           return "Orders{" +
                   "id=" + id +
                   ", number='" + number + '\'' +
                   ", createTime=" + createTime +
                   ", note='" + note + '\'' +
                   '}';
       }
   }
   ```

4. OrderDetail类

   ```java
   package com.mybatis.pojo;
   
   public class OrderDetail {
       private Integer id;
   
       private Integer itemsNum;
   
       public Integer getId() {
           return id;
       }
   
       public void setId(Integer id) {
           this.id = id;
       }
   
       public Integer getItemsNum() {
           return itemsNum;
       }
   
       public void setItemsNum(Integer itemsNum) {
           this.itemsNum = itemsNum;
       }
   }
   ```

## 简单查询

1. 查询所有用户信息

   + UserMapper接口

     ```java
     package com.mybatis.mapper;
     
     import com.mybatis.pojo.User;
     import org.apache.ibatis.annotations.Param;
     
     import java.util.List;
     
     public interface UserMapper {
            List<User> queryAll();
     }
     ```

   + UserMapper.xml映射文件

     ```xml
     <?xml version="1.0" encoding="UTF-8"?>
     <!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
     <mapper namespace="com.mybatis.mapper.UserMapper">
         <select id="queryAll" resultType="com.mybatis.pojo.User">
             select * from user;
         </select>
     </mapper>
     ```

   + 测试程序

     ```java
     @Test
     public void testUserAll(){
         SqlSession session = MyBatisUtil.getSession();
         UserMapper mapper = session.getMapper(UserMapper.class);
         List<User> users = mapper.queryAll();
         System.out.println(users);
         session.close();
     }
     ```

2. 根据ID查询用户信息

   + UserMapper接口

     ```java
     package com.mybatis.mapper;
     
     import com.mybatis.pojo.User;
     import org.apache.ibatis.annotations.Param;
     
     import java.util.List;
     
     public interface UserMapper {
         User queryById(@Param("id") Integer id);
     }
     ```

   + UserMapper.xml映射文件 

     ```xml
     <?xml version="1.0" encoding="UTF-8"?>
     <!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
     <mapper namespace="com.mybatis.mapper.UserMapper">
         <select id="queryById" resultType="com.mybatis.pojo.User">
             select * from user where id = #{id}
         </select>
     </mapper>
     ```

   + 测试程序

     ```java
     @Test
     public void testQueryUserById(){
         SqlSession session = MyBatisUtil.getSession();
         UserMapper mapper = session.getMapper(UserMapper.class);
         User user = mapper.queryById(1);
         System.out.println(user);
         session.close();
     }
     ```

3. 查询ID查询Orders信息

   + OrdersMapper接口 

     ```java
     package com.mybatis.mapper;
     
     import com.mybatis.pojo.Orders;
     import org.apache.ibatis.annotations.Param;
     
     public interface OrdersMapper {
         Orders queryById(@Param("id") Integer id);
     }
     ```

   + OrdersMapper.xml映射文件

     ```xml
     <?xml version="1.0" encoding="UTF-8"?>
     <!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
     <mapper namespace="com.mybatis.mapper.OrdersMapper">
     
         <select id="queryById" resultType="com.mybatis.pojo.Orders">
             select * from orders where id = #{id}
         </select>
     </mapper>
     ```

   + 测试程序

     ```java
     @Test
     public void test03(){
         SqlSession session = MyBatisUtil.getSession();
         OrdersMapper ordersMapper = session.getMapper(OrdersMapper.class);
         Orders orders = ordersMapper.queryById(1);
         System.out.println(orders);
         session.close();
     }
     ```

## 一对一查询

### 查询全部订单信息，并查询相关的用户信息（使用ResultType）

+ 新建OrderCustom类，该类继承Orders类，在该类中添加User的属性

  ```java
  package com.mybatis.pojo;
  
  import java.util.Date;
  
  public class OrderCustom extends Orders {
      private Integer id;
  
      private String username;
  
      private Date birthday;
  
      private String sex;
  
      private String address;
  
      @Override
      public Integer getId() {
          return id;
      }
  
      @Override
      public void setId(Integer id) {
          this.id = id;
      }
  
      public String getUsername() {
          return username;
      }
  
      public void setUsername(String username) {
          this.username = username;
      }
  
      public Date getBirthday() {
          return birthday;
      }
  
      public void setBirthday(Date birthday) {
          this.birthday = birthday;
      }
  
      public String getSex() {
          return sex;
      }
  
      public void setSex(String sex) {
          this.sex = sex;
      }
  
      public String getAddress() {
          return address;
      }
  
      public void setAddress(String address) {
          this.address = address;
      }
  
      @Override
      public String toString() {
          return "OrderCustom{" +
                  super.toString() +
                  "id=" + id +
                  ", username='" + username + '\'' +
                  ", birthday=" + birthday +
                  ", sex='" + sex + '\'' +
                  ", address='" + address + '\'' +
                  "} " + "\n";
      }
  }
  ```

+ OrderCustomMapper接口

  ```java
  package com.mybatis.mapper;
  
  import com.mybatis.pojo.OrderCustom;
  
  import java.util.List;
  
  public interface OrderCustomMapper {
      List<OrderCustom> queryAll();
  }
  ```

+ OrderCustomMapper.xml映射文件

  ```xml
  <?xml version="1.0" encoding="UTF-8"?>
  <!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  <mapper namespace="com.mybatis.mapper.OrderCustomMapper">
  
  
      <select id="queryAll" resultType="com.mybatis.pojo.OrderCustom">
          select orders.*,user.*
          from orders, user
          where orders.user_id = user.id;
      </select>
  </mapper>
  ```

+ 测试程序

  ```java
  @Test
  public void testOrderCustom(){
      SqlSession session = MyBatisUtil.getSession();
      OrderCustomMapper mapper = session.getMapper(OrderCustomMapper.class);
      List<OrderCustom> orderCustoms = mapper.queryAll();
      System.out.println(orderCustoms);
      session.close();
  }
  ```

### 查询全部订单信息，并查询相关的用户信息（使用ResultMap）

+ 在Orders类中添加新的属性

  ```java
  private User user;
  public User getUser() {
      return user;
  }
  
  public void setUser(User user) {
      this.user = user;
  }
  ```

+ OrderCustomMapper接口

  ```java
  package com.mybatis.mapper;
  
  import com.mybatis.pojo.OrderCustom;
  import com.mybatis.pojo.Orders;
  
  import java.util.List;
  
  public interface OrderCustomMapper {
  
       List<Orders> queryOrderUserByResultMap();
  }
  ```

+ OrderCustomMapper.xml映射文件

  ```xml
  <?xml version="1.0" encoding="UTF-8"?>
  <!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  <mapper namespace="com.mybatis.mapper.OrderCustomMapper">
  
      <!--将整个结果集映射到com.mybatis.pojo.Orders中-->
      <resultMap id="OrdersUserResultMap" type="com.mybatis.pojo.Orders">
          <id column="id" property="id"/>
          <result column="user_id" property="userId"/>
          <result column="number" property="number"/>
          <result column="create_time" property="createTime"/>
          <result column="note" property="note"/>
  
          <!--配置映射的关联用户信息-->
          <!--association：用于映射关联查询单个对象信息-->
          <association property="user" javaType="com.mybatis.pojo.User">
              <id column="id" property="id"/>
              <result column="username" property="username"/>
              <result column="birthday" property="birthday"/>
              <result column="sex" property="sex"/>
              <result column="address" property="address"/>
          </association>
      </resultMap>
  
      <select id="queryOrderUserByResultMap" resultMap="OrdersUserResultMap">
          select orders.*,user.*
          from orders, user
          where orders.user_id = user.id;
      </select>
      
  </mapper>
  ```

+ 测试程序

  ```java
  @Test
  public void testOrderCustomByResultMap(){
      SqlSession session = MyBatisUtil.getSession();
      OrderCustomMapper mapper = session.getMapper(OrderCustomMapper.class);
      List<Orders> orders = mapper.queryOrderUserByResultMap();
      System.out.println(orders);
      session.close();
  }
  ```

## 一对多查询（查询订单及订单明细，以及订单对应的用户信息）

+ 在Orders类中添加属性

  ```java
  private List<OrderDetail> orderDetails;
  public List<OrderDetail> getOrderDetails() {
      return orderDetails;
  }
  
  public void setOrderDetails(List<OrderDetail> orderDetails) {
      this.orderDetails = orderDetails;
  ```

+ OrderCustomMapper接口

  ```java
  List<Orders> queryOrdersAndOrderDetail();
  ```

+ OrderCustomMapper.xml映射文件

  ```xml
  <resultMap id="OrdersAndOrderDetailResultMap" type="com.mybatis.pojo.Orders">
      <!--订单信息-->
      <id column="id" property="id"/>
      <result column="user_id" property="userId"/>
      <result column="number" property="number"/>
  
      <!--用户信息-->
      <association property="user" javaType="com.mybatis.pojo.User">
          <id column="id" property="id"/>
          <result column="username" property="username"/>
          <result column="sex" property="sex"/>
          <result column="address" property="address"/>
      </association>
  
      <!--订单明细信息-->
      <collection property="orderDetails" ofType="com.mybatis.pojo.OrderDetail">
          <id column="id" property="id"/>
          <result column="orders_id" property="ordersId"/>
          <result column="items_id" property="itemsId"/>
          <result column="items_num" property="itemsNum"/>
      </collection>
  </resultMap>
  
  
  
  <select id="queryOrdersAndOrderDetail" resultMap="OrdersAndOrderDetailResultMap">
      select orders.id, user_id, number,user.id, username, sex, address,order_detail.id, orders_id, items_id, items_num
      from orders,  user, order_detail
      where orders.user_id = user.id and orders.id = order_detail.orders_id;
  </select>
  ```

+ 测试程序

  ```java
  @Test
  public void testQueryOrdersAndOrderDetail(){
      SqlSession session = MyBatisUtil.getSession();
      OrderCustomMapper mapper = session.getMapper(OrderCustomMapper.class);
      List<Orders> orders = mapper.queryOrdersAndOrderDetail();
      System.out.println(orders);
      session.close();
  }
  ```



## 多对多查询（查询用户及用户所购买的商品信息）

+ 在对应的java类中添加属性

  1. 在User类中添加

     ```java
     private List<Orders> orders;
     ```

  2. 在Orders类中添加

     ```java
     private List<OrderDetail> orderDetails;
     ```

  3. 在OrderDetail类中添加

     ```java
     private Items items;
     ```

+ Mapper接口文件

  ```java
  List<User> queryUserAndItem();
  ```

+ Mapper.xml映射文件

  ```xml
  <!--多对多查询-->
  <resultMap id="UserAndItemResultMap" type="com.mybatis.pojo.User">
      <!--用户信息-->
      <id column="user_id" property="id"/>
      <result column="username" property="username"/>
      <result column="user_sex" property="sex"/>
      <result column="user_address" property="address"/>
  
      <!--订单信息-->
      <collection property="orders" ofType="com.mybatis.pojo.Orders">
          <id column="orders_id" property="id"/>
          <result column="orders_number" property="number"/>
  
          <!--订单明细-->
          <collection property="orderDetails" ofType="com.mybatis.pojo.OrderDetail">
              <id column="order_detail_id" property="id"/>
              <result column="items_num" property="itemsNum"/>
              <!--商品信息-->
              <association property="items" javaType="com.mybatis.pojo.Items">
                  <id column="items_id" property="id"/>
                  <result column="item_name" property="name"/>
                  <result column="item_price" property="price"/>
              </association>
          </collection>
      </collection>
  </resultMap>
  
  <select id="queryUserAndItem" resultMap="UserAndItemResultMap">
      select user.id user_id, username , sex user_sex, address user_address,
             orders.id orders_id, number orders_number,
             order_detail.id order_detail_id, items_num,
             items.id item_id, name item_name, price item_price
      from orders,  user, order_detail, items
      where orders.user_id = user.id
        and orders.id = order_detail.orders_id
        and order_detail.items_id = items.id;
  </select>
  ```

+ 测试程序

  ```java
      @Test
      public void testQueryUserAndItem(){
          SqlSession session = MyBatisUtil.getSession();
          OrderCustomMapper mapper = session.getMapper(OrderCustomMapper.class);
          List<User> users = mapper.queryUserAndItem();
  
          Iterator iterator = users.iterator();
          while (iterator.hasNext()){
              System.out.println(iterator.next());
          }
  
  //        System.out.println(users);
          session.close();
      }
  ```


