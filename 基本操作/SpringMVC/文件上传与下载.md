# 文件上传与下载

## 文件上传

1. 添加依赖

   ```xml
   <!-- https://mvnrepository.com/artifact/commons-fileupload/commons-fileupload -->
   <dependency>
       <groupId>commons-fileupload</groupId>
       <artifactId>commons-fileupload</artifactId>
       <version>1.4</version>
   </dependency>
   ```

2. 在spring-servlet.xml中注册文件上传解析器

   ```xml
   <!--文件上传解析器-->
   <!--id必须是multipartResolver-->
   <bean class="org.springframework.web.multipart.commons.CommonsMultipartResolver" id="multipartResolver">
       <!--定义上传文件总大小，单位：bytes-->
       <property name="maxUploadSize" value="1048576000"/>
       <!--指定默认上传编码-->
       <property name="defaultEncoding" value="UTF-8"/>
       <!--定义上传文件单个大小-->
       <property name="maxUploadSizePerFile" value="10485760"/>
   
   </bean>
   ```

3. 前台页面程序

   ```jsp
   <%@ page contentType="text/html;charset=UTF-8" language="java" %>
   <html>
   <head>
       <title>Title</title>
   </head>
   <body>
   
       <form action="${context}/file/upload" method="post"enctype="multipart/form-data">
           文件：<input type="file" name="file"><br>
           <input type="submit" value="提交">
   
       </form>
   </body>
   </html>
   ```

4. 后台处理程序

   ```java
   package com.spring.controller;
   
   
   import org.springframework.stereotype.Controller;
   import org.springframework.ui.Model;
   import org.springframework.web.bind.annotation.RequestMapping;
   import org.springframework.web.bind.annotation.RequestParam;
   import org.springframework.web.multipart.MultipartFile;
   
   import java.io.File;
   import java.io.IOException;
   import java.util.Date;
   
   @Controller
   @RequestMapping("/file")
   public class FileController {
   
   
       @RequestMapping("/upload")
       public String upload(@RequestParam("file") MultipartFile multipartFile, Model model){
           //上传文件路径
           String uploadPath =  "F:" + File.separator;
   
           //判断文件是否为空
           if (multipartFile != null && !multipartFile.isEmpty()){
   //            取得文件原始名称
               String originalFilename = multipartFile.getOriginalFilename();
   //            取得文件名前缀
               String fileNamePrefix = originalFilename.substring(0,originalFilename.lastIndexOf("."));
   //            取得文件名后缀
               String fileNameSuffix = originalFilename.substring(originalFilename.lastIndexOf("."));
   //            加工文件名
               String newFileNamePrefix = fileNamePrefix + new Date().getTime();
   //            得到新的文件名
               String newFileName = newFileNamePrefix + fileNameSuffix;
   //            构建文件对象
               File file = new File(uploadPath + newFileName);
   //            上传
               try {
                   multipartFile.transferTo(file);
                   model.addAttribute("fileName", newFileName);
               } catch (IOException e) {
                   e.printStackTrace();
               }
           }
   
           return "uploadSuccess";
       }
   }
   ```

## 批量上传

1. 前台页面程序

   ```jsp
   <%@ page contentType="text/html;charset=UTF-8" language="java" %>
   <html>
   <head>
       <title>Title</title>
   </head>
   <body>
   
       <form action="${context}/file/upload2" method="post"enctype="multipart/form-data">
           文件：<input type="file" name="file"><br>
           文件：<input type="file" name="file"><br>
           文件：<input type="file" name="file"><br>
           文件：<input type="file" name="file"><br>
           <input type="submit" value="提交">
   
       </form>
   </body>
   </html>
   ```

2. 后台处理程序

   ```java
   @RequestMapping("/upload2")
       public String upload2(@RequestParam("file") MultipartFile[] multipartFiles, Model model){
           //上传文件路径
           String uploadPath =  "F:" + File.separator;
           List<String> fileNames = new ArrayList<>();
   
           for (MultipartFile multipartFile: multipartFiles){
               //判断文件是否为空
               if (multipartFile != null && !multipartFile.isEmpty()){
   //            取得文件原始名称
                   String originalFilename = multipartFile.getOriginalFilename();
   //            取得文件名前缀
                   String fileNamePrefix = originalFilename.substring(0,originalFilename.lastIndexOf("."));
   //            取得文件名后缀
                   String fileNameSuffix = originalFilename.substring(originalFilename.lastIndexOf("."));
   //            加工文件名
                   String newFileNamePrefix = fileNamePrefix + new Date().getTime();
   //            得到新的文件名
                   String newFileName = newFileNamePrefix + fileNameSuffix;
   //            构建文件对象
                   File file = new File(uploadPath + newFileName);
   //            上传
                   try {
                       multipartFile.transferTo(file);
                       fileNames.add(newFileName);
                   } catch (IOException e) {
                       e.printStackTrace();
                   }
               }
           }
           model.addAttribute("fileNames", fileNames);
   
           return "uploadSuccess";
       }
   ```


## 使用Servlet3.0新特性完成文件上传

1. 在spring-servlet.xml文件中添加一个bean

   ```xml
   <bean class="org.springframework.web.multipart.support.StandardServletMultipartResolver" id="multipartResolver">
       
   </bean>
   ```

2. 在web.xml文件中定义相关属性（multipart-config）

   ```xml
   <servlet>
       <servlet-name>dispatcherServlet</servlet-name>
       <servlet-class>org.springframework.web.servlet.DispatcherServlet</servlet-class>
       <init-param>
           <param-name>contextConfigLocation</param-name>
           <param-value>classpath:spring-servlet.xml</param-value>
       </init-param>
   
       <multipart-config>
           <file-size-threshold></file-size-threshold>
           <max-file-size></max-file-size>
           <max-request-size></max-request-size>
       </multipart-config>
   
   </servlet>
   ```

3. 其余不变

## 文件下载

1. 后台程序

   ```java
   package com.spring.controller;
   
   import org.springframework.stereotype.Controller;
   import org.springframework.web.bind.annotation.RequestMapping;
   
   import javax.servlet.http.HttpServletResponse;
   import java.io.File;
   import java.io.IOException;
   import java.io.UnsupportedEncodingException;
   import java.nio.file.Files;
   import java.nio.file.Path;
   import java.nio.file.Paths;
   
   @Controller
   @RequestMapping("/download")
   public class DownloadController {
   
       @RequestMapping("/downFile")
       public String downFile(HttpServletResponse response)  {
           // 取得文件路径
           String parentPath = "F:" + File.separator;
           // 取得文件名称
           String fileName = "小黄图.jpg";
           // 取得文件对象
           Path path = Paths.get(parentPath, fileName);
           // 判断文件是否为空
           if (Files.exists(path)){
               // 取得文件后缀名
               String fileNameSuffix = fileName.substring(fileName.lastIndexOf(".") + 1);
               // 设置文本类型
               response.setContentType("application/" + fileNameSuffix);
   
               // 设置头信息
               try {
                   response.addHeader("Content-Disposition", "attachment; fileName=" + new String(fileName.getBytes("UTF-8"), "ISO8859-1"));
               } catch (UnsupportedEncodingException e) {
                   e.printStackTrace();
               }
               // 下载文件
               try {
                   Files.copy(path, response.getOutputStream());
               } catch (IOException e) {
                   e.printStackTrace();
               }
   
           }
           return null;
       }
   }
   
   ```

2. 







